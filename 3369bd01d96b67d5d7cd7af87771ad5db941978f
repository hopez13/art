{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "08e2ff75_3f8bd2c9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1022077
      },
      "writtenOn": "2021-04-29T16:25:15Z",
      "side": 1,
      "message": "What\u0027s the impact on the size? Should this be backed by a flag for devices with limited storage space?",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c9f91b0d_49e526a1",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1558410
      },
      "writtenOn": "2021-04-29T18:09:36Z",
      "side": 1,
      "message": "In-memory size should not be affected, on-disk size.\nlibart.so: 8726416 -\u003e 10098576\nlibart-compiler.so: 3305640 -\u003e 6426816\n\nIs there an existing solution for flagging off options for low storage devices.",
      "parentUuid": "08e2ff75_3f8bd2c9",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c057fcb2_2aa21f67",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1022077
      },
      "writtenOn": "2021-04-29T20:17:44Z",
      "side": 1,
      "message": "I think you can have a board config flag to configure this. +ccross in how this could be integrated.\n\nThis is about 5MB storage increase and maybe not such a big concern, but I would check with someone working with such devices to understand the expectations. + rajekumar +tjoinnes\n\nAlso, I\u0027m assuming you want to do this on a larger scale (not only to art .so) so gating it might be a good idea.",
      "parentUuid": "c9f91b0d_49e526a1",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3b94498d_eb2b2cfb",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1148397
      },
      "writtenOn": "2021-04-29T20:21:34Z",
      "side": 1,
      "message": "No objection from me on the 5MB disk space hit. I\u0027m not sure our kernels will support THP to start though. I defer to Rajeev\u0027s judgement.",
      "parentUuid": "c057fcb2_2aa21f67",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0e7a8fe8_3eadd6a0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1248808
      },
      "writtenOn": "2021-04-29T20:30:18Z",
      "side": 1,
      "message": "5MB disk space hit is not super concerning if it can lead to the significant performance improvements. Maybe we should also capture performance improvements data on a Wembley device. \n\nIn general having a config flag to enable/disable it is a great idea and I agree with Calin\u0027s suggestions about it.",
      "parentUuid": "3b94498d_eb2b2cfb",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ce8abf57_6ffda432",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1558410
      },
      "writtenOn": "2021-04-29T21:25:15Z",
      "side": 1,
      "message": "Per ccross@, \"We generally discourage config variables as much as possible because it inevitably leads to breakages of branches that are not tested in presubmit. If there is no objection to turning it on globally I\u0027d leave out the config variable.\" Are we alright with moving forward with a a global enable",
      "parentUuid": "0e7a8fe8_3eadd6a0",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2c2401a6_624703c3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1038443
      },
      "writtenOn": "2021-04-30T08:49:17Z",
      "side": 1,
      "message": "We would like to know the benefits before doing so - ART is now a mainline module and any size increase has consequences. We also don\u0027t want to produce different binaries whether running on Go or regular Android.",
      "parentUuid": "ce8abf57_6ffda432",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7750c6e2_a3c1d7f3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1018108
      },
      "writtenOn": "2021-04-30T09:16:26Z",
      "side": 1,
      "message": "We would also like to know more about how transparent huge pages work to determine what are the actual benefits.\n\nWith this CL: The tail part of a section (say .text) can be a lot less that 2MiB. Are we going to use a huge page for the tail and waste valuable RAM? (I assume we cannot reuse the rest of the physical page for other small-page data as that could be potentially used as a side-channel for that data.)\n\nWithout this CL: If a section is bigger than 2MiB and happens to cover an entire aligned 2MiB area, would we not use a huge page anyway? (Which would mean that this CL is useful only for the head and tail parts, with the above concern about the tail.)",
      "parentUuid": "2c2401a6_624703c3",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e7bacb1a_d4797957",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1558410
      },
      "writtenOn": "2021-04-30T15:45:04Z",
      "side": 1,
      "message": "THPs will only be used for full 2MB chunks of the section, so the tail will stay on 4KB pages.\n\nBoth VMA and file offset both need to be 2MB aligned to use THPs, this can lead to hugepages covering different functions or not being used at all when there is no explicit alignment.",
      "parentUuid": "7750c6e2_a3c1d7f3",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "90938df8_74086bfa",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1071150
      },
      "writtenOn": "2021-04-30T15:59:02Z",
      "side": 1,
      "message": "Sounds good. So the storage growth is because the tail isn\u0027t on 4KB blocks in the file? In which case, the extra space might compress well(?).\n\nThe concern with space is magnified for mainline modules, there will be one copy of these libraries in the system installed apex and one in any updates that are shipped.\n\nThe updates ship from Play so if we\u0027re not able to compress the extra space here, that\u0027s costly. IDNK if Play diff/compress tooling is able to look inside APEXes. It is potentially costly there (bytes served, network costs).",
      "parentUuid": "e7bacb1a_d4797957",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dad1913e_e7ea348d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1018108
      },
      "writtenOn": "2021-04-30T16:06:01Z",
      "side": 1,
      "message": "The explicit alignment requirement for VMA seems to be an unnecessary restriction on THPs. I guess I have a feature request to allow THPs even when the section is not explicitly 2MiB aligned.\n\nThe file offset alignment requirement seems like a filesystem waste. Or can we use a sparse .so file to avoid that waste?",
      "parentUuid": "e7bacb1a_d4797957",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "965c8d07_f0b92143",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1558410
      },
      "writtenOn": "2021-04-30T16:26:43Z",
      "side": 1,
      "message": "I don\u0027t believe the VMA requirement can be removed, since THPs work by collapsing all of the PTEs for a given region into the second-level (2MiB) page table.\n\nThe files do compress well (3.15 vs 3.16 MiB on disk). Is there an alternate sparse ELF format available?",
      "parentUuid": "dad1913e_e7ea348d",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2511b8a8_a9241cf9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1071150
      },
      "writtenOn": "2021-04-30T16:56:39Z",
      "side": 1,
      "message": "I\u0027ve sent inquiries to see if file-by-file diffing for APEXes made it to play (failed to find a tracking bug). If so, these would compress well in the update. A sparse format would be better either way.",
      "parentUuid": "965c8d07_f0b92143",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "381b0617_a6048123",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1018108
      },
      "writtenOn": "2021-05-04T08:12:29Z",
      "side": 1,
      "message": "Given that the tail is already ignored, I see no reason for the head to be treated differenly. The VMA alignment requirement is certainly not required for THPs to work on the middle regions.",
      "parentUuid": "2511b8a8_a9241cf9",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a424ae09_5cce903c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1558410
      },
      "writtenOn": "2021-05-04T16:16:59Z",
      "side": 1,
      "message": "These libraries tend to have text sections ~2-6MiB. It\u0027s very likely that there will be no, or a reduced number of, 2-MiB aligned middle regions if there\u0027s no explicit alignment.",
      "parentUuid": "381b0617_a6048123",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "af6b35b0_7f71f0b8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1558410
      },
      "writtenOn": "2021-05-04T17:37:30Z",
      "side": 1,
      "message": "https://github.com/torvalds/linux/blob/5bfc75d92efd494db37f5c4c173d3639d4772966/mm/khugepaged.c#L463\n\nThis is the relevant condition in hugepage_vma_check. The vma start address and offset into the file need to be 2-MiB aligned for this to be reliably true. This is unlikely enough without explicit alignment that marking every library\u0027s text segment as hugepage eligible results in no eligible regions.",
      "parentUuid": "a424ae09_5cce903c",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1cb8213e_3a40539a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1018108
      },
      "writtenOn": "2021-05-04T18:02:45Z",
      "side": 1,
      "message": "The code comment there states the requirement but it is silent about the reason. I\u0027m saying that THPs could be implemented to support middle regions of unaligned sections. (No matter how rarely we would actually have a section span a whole aligned 2MiB part of memory.)\n\nYou\u0027re working with the existing kernel implementation. I\u0027m questioning the rationale behind it, pointing to the fact that the requirements could be relaxed.",
      "parentUuid": "af6b35b0_7f71f0b8",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "6e8a6b3b_93b8c585",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1018108
      },
      "writtenOn": "2021-05-18T16:16:23Z",
      "side": 1,
      "message": "For the time being, let\u0027s work with the current kernel implementation and get this in. After all the discussions, the most concerning impact seems to be the additional virtual address space use (scarce resource on 32-bit targets) but we expect that to be OK.",
      "parentUuid": "1cb8213e_3a40539a",
      "revId": "3369bd01d96b67d5d7cd7af87771ad5db941978f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}